{% extends 'properties/base.html' %}
{% load static %}

{% block title %}Advanced Property Search{% endblock %}

{% block content %}
<!-- Advanced Search Hero -->
<section class="search-hero bg-gradient-primary py-5 text-white">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="display-4 fw-bold mb-3">Advanced Search</h1>
                <p class="lead">Find exactly what you're looking for with our powerful filters</p>
            </div>
            <div class="col-lg-6">
                <div class="quick-search mb-4">
                    <form method="get" class="row g-3">
                        <div class="col-md-5">
                            <input type="text" class="form-control" name="q" placeholder="Enter location or keywords" value="{{ request.GET.q }}">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" name="property_type">
                                <option value="">Any Type</option>
                                {% for value, label in property_types %}
                                    <option value="{{ value }}" {% if request.GET.property_type == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-light w-100">
                                <i class="bi bi-search"></i> Quick Search
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Comprehensive Filters -->
<section class="filters-section py-5 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Location</h5>
                    </div>
                    <div class="card-body">
                        <form method="get">
                            <div class="mb-3">
                                <input type="text" class="form-control" name="q" placeholder="City, neighborhood, or address" value="{{ request.GET.q }}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold small">Cities</label>
                                <select class="form-select form-select-sm" name="city" multiple size="5">
                                    {% for city in cities %}
                                        <option value="{{ city }}" {% if request.GET.city == city %}selected{% endif %}>{{ city }} ({{ city_count|default:"-" }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-tag"></i> Property Details</h5>
                    </div>
                    <div class="card-body">
                        <form method="get">
                            <div class="mb-3">
                                <label class="form-label fw-bold small">Type</label>
                                <select class="form-select form-select-sm" name="property_type">
                                    <option value="">Any Type</option>
                                    {% for value, label in property_types %}
                                        <option value="{{ value }}" {% if request.GET.property_type == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold small">Listing Type</label>
                                <select class="form-select form-select-sm" name="listing_type">
                                    <option value="">Any</option>
                                    {% for value, label in listing_types %}
                                        <option value="{{ value }}" {% if request.GET.listing_type == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold small">Bedrooms</label>
                                <select class="form-select form-select-sm" name="min_bedrooms">
                                    <option value="">Any</option>
                                    <option value="1" {% if request.GET.min_bedrooms == '1' %}selected{% endif %}>1+</option>
                                    <option value="2" {% if request.GET.min_bedrooms
                            <option value="3" {% if request.GET.min_bedrooms == '3' %}selected{% endif %}>3+</option>
                            <option value="4" {% if request.GET.min_bedrooms == '4' %}selected{% endif %}>4+</option>
                            <option value="5" {% if request.GET.min_bedrooms == '5' %}selected{% endif %}>5+</option>
                        </select>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-currency-dollar"></i> Price & More</h5>
                </div>
                <div class="card-body">
                    <form method="get">
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Price Range</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" name="min_price" placeholder="Min" value="{{ request.GET.min_price }}">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" name="max_price" placeholder="Max" value="{{ request.GET.max_price }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Bathrooms</label>
                            <select class="form-select form-select-sm" name="min_bathrooms">
                                <option value="">Any</option>
                                <option value="1" {% if request.GET.min_bathrooms == '1' %}selected{% endif %}>1+</option>
                                <option value="2" {% if request.GET.min_bathrooms == '2' %}selected{% endif %}>2+</option>
                                <option value="3" {% if request.GET.min_bathrooms == '3' %}selected{% endif %}>3+</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_waterfront" value="true" id="waterfront" {% if request.GET.is_waterfront == 'true' %}checked{% endif %}>
                                <label class="form-check-label small" for="waterfront">Waterfront Property</label>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">Apply Filters</button>
                            <a href="{% url 'property_list' %}" class="btn btn-outline-secondary btn-sm">Reset All</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Map View Toggle -->
<section class="map-toggle py-3 bg-white border-bottom">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="fw-bold me-2">{{ total_count }} Properties Found</span>
                <small class="text-muted">Matching your search criteria</small>
            </div>
            <div class="btn-group" role="group">
                <a href="#list-view" class="btn btn-outline-primary active" onclick="showListView()">
                    <i class="bi bi-list-ul"></i> List View
                </a>
                <a href="#map-view" class="btn btn-outline-primary" onclick="showMapView()">
                    <i class="bi bi-geo-alt"></i> Map View
                </a>
            </div>
        </div>
    </div>
</section>

<!-- Results Section -->
<section id="list-view" class="properties-section py-5">
    <div class="container">
        <!-- EXACT SAME PROPERTY GRID AS property_list.html -->
        <div class="row">
            <div class="col-lg-9">
                {% if properties %}
                    <div class="row g-4">
                        {% for property in properties %}
                            <div class="col-md-6 col-lg-4">
                                <!-- IDENTICAL PROPERTY CARD FROM property_list.html -->
                                <div class="card property-card h-100">
                                    <div class="position-relative">
                                        {% if property.images.all %}
                                            {% with property.images.all.0 as first_image %}
                                                <img src="{{ first_image.image.url }}" class="card-img-top" alt="{{ property.title }}" loading="lazy">
                                            {% endwith %}
                                        {% else %}
                                            <img src="https://via.placeholder.com/400x250?text=No+Image" class="card-img-top" alt="No image">
                                        {% endif %}
                                        
                                        {% if user.is_authenticated %}
                                            <form method="post" action="{% url 'property_favorite_toggle' property.pk %}" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="favorite-btn">
                                                    <i class="bi bi-heart-fill"></i>
                                                </button>
                                            </form>
                                        {% endif %}

                                        <span class="badge bg-primary position-absolute top-0 start-0 m-2">
                                            {{ property.get_listing_type_display }}
                                        </span>
                                    </div>
                                    
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <a href="{% url 'property_detail' property.pk %}" class="text-decoration-none text-dark">
                                                {{ property.title|truncatewords:8 }}
                                            </a>
                                        </h5>
                                        
                                        <p class="property-price mb-2">
                                            {{ property.currency }} {{ property.price|floatformat:0 }}
                                        </p>
                                        
                                        <p class="text-muted small mb-3">
                                            <i class="bi bi-geo-alt"></i> {{ property.city }}, {{ property.state }}
                                        </p>
                                        
                                        <div class="d-flex gap-3 text-muted small">
                                            {% if not property.is_land %}
                                                {% if property.bedrooms %}
                                                    <span><i class="bi bi-door-closed"></i> {{ property.bedrooms }} Beds</span>
                                                {% endif %}
                                                {% if property.bathrooms %}
                                                    <span><i class="bi bi-droplet"></i> {{ property.bathrooms }} Baths</span>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="card-footer bg-white border-top-0">
                                        <a href="{% url 'property_detail' property.pk %}" class="btn btn-outline-primary w-100">
                                            View Details <i class="bi bi-arrow-right"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- IDENTICAL PAGINATION FROM property_list.html -->
                    {% if properties.has_other_pages %}
                        <nav aria-label="Page navigation" class="mt-5">
                            <ul class="pagination justify-content-center">
                                {% if properties.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page=1&{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}">
                                            <i class="bi bi-chevron-double-left"></i>
                                        </a>
                                    </li>
                                {% endif %}
                                <!-- Page numbers... -->
                            </ul>
                        </nav>
                    {% endif %}
                {% else %}
                    <!-- IDENTICAL EMPTY STATE -->
                    <div class="text-center py-5">
                        <i class="bi bi-search display-1 text-muted"></i>
                        <h3 class="mt-3">No Properties Match</h3>
                        <p class="text-muted">Try broadening your search criteria</p>
                        <a href="{% url 'property_search' %}" class="btn btn-primary mt-3">New Search</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Map View (Hidden by default) -->
<section id="map-view" class="map-results py-5" style="display: none;">
    <div class="container">
        <div id="searchMap" style="height: 600px; border-radius: 10px;"></div>
    </div>
</section>

<script>
function showListView() {
    document.getElementById('list-view').style.display = 'block';
    document.getElementById('map-view').style.display = 'none';
}
function showMapView() {
    document.getElementById('list-view').style.display = 'none';
    document.getElementById('map-view').style.display = 'block';
}

}
</script>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initSearchMap" async defer></script>
<script>
let searchMarkers = [];
function initSearchMap() {
    const map = new google.maps.Map(document.getElementById('searchMap'), {
        zoom: 10,
        center: {lat: -1.2921, lng: 36.8219}  // Default Nairobi
    });
    
    {% for property in properties %}
        const marker{{ property.pk }} = new google.maps.Marker({
            position: {lat: {{ property.latitude|default:0 }}, lng: {{ property.longitude|default:0 }}},
            map: map,
            title: '{{ property.title }}',
            icon: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
        });
        
        const infoWindow{{ property.pk }} = new google.maps.InfoWindow({
            content: `
                <div style="max-width: 200px;">
                    <h6>${{{ property.title|escapejs|slice:":50" }}}...</h6>
                    <p><strong>${{{ property.currency|escapejs }}} {{ property.price|floatformat:0 }}</strong></p>
                    <p>{{ property.city }}</p>
                    <a href="{% url 'property_detail' {{ property.pk }} %}" style="color: #007bff;">View Details</a>
                </div>
            `
        });
        
        marker{{ property.pk }}.addListener('click', () => {
            infoWindow{{ property.pk }}.open(map, marker{{ property.pk }});
        });
        searchMarkers.push(marker{{ property.pk }});
    {% endfor %}
}
</script>
{% endblock %}

