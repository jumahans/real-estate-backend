{% extends "admin/base_site.html" %}
{% load i18n static humanize %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        --brand-emerald: #1B4D3E;
        --brand-gold: #C5A059;
        --brand-dark: #0f2b23;
        --bg-light: #f4f6f9;
        --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .analytics-container { padding: 25px; background: var(--bg-light); font-family: 'Inter', sans-serif; }

    /* HEADER */
    .analytics-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .header-title h2 { margin: 0; color: var(--brand-dark); font-weight: 800; font-size: 1.8rem; }

    /* KPI CARDS */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; border-radius: 15px; padding: 25px; box-shadow: var(--card-shadow); position: relative; overflow: hidden; transition: transform 0.3s ease; }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-card::before { content: ""; position: absolute; top: 0; left: 0; width: 5px; height: 100%; }
    .stat-card.revenue::before { background: var(--brand-gold); }
    .stat-card.sales::before { background: var(--brand-emerald); }
    .stat-label { display: block; color: #888; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; font-weight: 700; margin-bottom: 10px; }
    .stat-value { font-size: 2rem; font-weight: 800; color: var(--brand-dark); margin: 0; }
    .stat-icon { position: absolute; right: 20px; bottom: 20px; font-size: 2.5rem; opacity: 0.1; color: var(--brand-dark); }

    /* CHARTS */
    .charts-main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 30px; }
    .chart-wrapper { background: white; border-radius: 15px; padding: 25px; box-shadow: var(--card-shadow); }
    .chart-title { font-weight: 700; color: var(--brand-emerald); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

    /* MANAGEMENT SECTION */
    .management-section { background: white; border-radius: 15px; padding: 20px; box-shadow: var(--card-shadow); margin-top: 25px; }
    .management-header { padding: 15px; border-bottom: 1px solid #eee; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    
    /* PRESERVE DJANGO ADMIN FUNCTIONALITY */
    #changelist { border: none; background: transparent; display: flex; flex-direction: column; }
    #changelist-form { order: 2; width: 100%; }
    #changelist-filter { 
        order: 1; margin-bottom: 20px; background: #fff; 
        border-radius: 10px; padding: 15px; border: 1px solid #eee; 
    }
    #changelist .results { border-radius: 10px; overflow: hidden; border: 1px solid #eee; }
    
    /* Make checkboxes and links highly visible */
    .action-checkbox { transform: scale(1.2); }
    th.column-title_display a { font-weight: bold; color: var(--brand-emerald) !important; text-decoration: underline !important; }

    @media (max-width: 1024px) { .charts-main-grid { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    
    <div class="analytics-header">
        <div class="header-title">
            <h2><i class="fas fa-chart-pie"></i> HQ Control Center</h2>
        </div>
        <div class="quick-nav">
            <a href="{% url 'admin:listings_property_add' %}" class="button" style="background: var(--brand-emerald); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600;">
                <i class="fas fa-plus"></i> List New Property
            </a>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card revenue">
            <span class="stat-label">Total Revenue (Sold)</span>
            <h3 class="stat-value" id="total-revenue">KES 0</h3>
            <i class="fas fa-hand-holding-usd stat-icon"></i>
        </div>
        <div class="stat-card sales">
            <span class="stat-label">Units Sold</span>
            <h3 class="stat-value" id="total-sold">0</h3>
            <i class="fas fa-key stat-icon"></i>
        </div>
        <div class="stat-card" style="border-left: 5px solid #3498db;">
            <span class="stat-label">Sell-Through Rate</span>
            <h3 class="stat-value" id="sell-rate">0%</h3>
            <i class="fas fa-percentage stat-icon"></i>
        </div>
        <div class="stat-card" style="border-left: 5px solid #e67e22;">
            <span class="stat-label">Inventory Level</span>
            <h3 class="stat-value" id="active-count">0</h3>
            <i class="fas fa-building stat-icon"></i>
        </div>
    </div>

    <div class="charts-main-grid">
        <div class="chart-wrapper">
            <div class="chart-title"><i class="fas fa-chart-line"></i> Sales Velocity (12 Months)</div>
            <div style="height: 350px;"><canvas id="salesVelocityChart"></canvas></div>
        </div>
        <div class="chart-wrapper">
            <div class="chart-title"><i class="fas fa-th-large"></i> Status Mix</div>
            <div style="height: 350px;"><canvas id="statusDistributionChart"></canvas></div>
        </div>
    </div>

    <div class="management-section">
        <div class="management-header">
            <h3 class="chart-title" style="margin:0;"><i class="fas fa-tasks"></i> Individual Property Management</h3>
            <div style="text-align: right;">
                <span style="color: #d35400; font-weight: bold; font-size: 0.85rem;">
                    <i class="fas fa-info-circle"></i> Click any Property Title to edit details or add images
                </span>
            </div>
        </div>

        <div id="content-main">
            {% block result_list %}
                {{ block.super }}
            {% endblock %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Dynamic API call to the analytics endpoint defined in PropertyAdmin
        fetch('analytics/')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-revenue').innerText = 'KES ' + data.total_revenue.toLocaleString();
                document.getElementById('total-sold').innerText = data.total_sold;
                document.getElementById('sell-rate').innerText = data.sell_rate + '%';
                document.getElementById('active-count').innerText = data.available;

                new Chart(document.getElementById('salesVelocityChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: data.data,
                            borderColor: '#1B4D3E',
                            backgroundColor: 'rgba(27, 77, 62, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                new Chart(document.getElementById('statusDistributionChart').getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Available', 'Sold'],
                        datasets: [{
                            data: [data.available, data.total_sold],
                            backgroundColor: ['#28a745', '#dc3545']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            });
    });
</script>
{% endblock %}