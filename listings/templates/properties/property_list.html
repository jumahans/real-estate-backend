{% extends 'properties/base.html' %}
{% load static %}

{% block title %}Browse Properties{% endblock %}

{% block content %}

<section class="hero-section bg-light py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6 mb-4 mb-lg-0">
                <h1 class="display-4 fw-bold mb-3">Find Your Dream Property</h1>
                <p class="lead text-muted">Browse {{ total_count }} available properties</p>
            </div>
            <div class="col-lg-6">
                <div class="search-box">
                    <form method="get" action="{% url 'property_list' %}">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control" name="search" placeholder="Search by location, title..." value="{{ search_query }}">
                            </div>
                            <div class="col-md-6">
                                <select class="form-select" name="property_type">
                                    <option value="">All Types</option>
                                    {% for value, label in property_types %}
                                        <option value="{{ value }}" {% if request.GET.property_type == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control" name="min_price" placeholder="Min Price" value="{{ request.GET.min_price }}">
                            </div>
                            <div class="col-md-4">
                                <input type="number" class="form-control" name="max_price" placeholder="Max Price" value="{{ request.GET.max_price }}">
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="filters-section py-3 bg-white border-bottom">
    <div class="container">
        <div class="d-flex flex-wrap gap-2 align-items-center">
            <span class="fw-bold me-2">Quick Filters:</span>
            {% for value, label in listing_types %}
                <a href="?listing_type={{ value }}" class="btn btn-sm btn-outline-primary {% if request.GET.listing_type == value %}active{% endif %}">
                    <i class="bi bi-tag"></i> {{ label }}
                </a>
            {% endfor %}
            <a href="?is_waterfront=true" class="btn btn-sm btn-outline-info {% if request.GET.is_waterfront == 'true' %}active{% endif %}">
                <i class="bi bi-water"></i> Waterfront
            </a>
            <a href="{% url 'property_list' %}" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-x-circle"></i> Clear All
            </a>
        </div>
    </div>
</section>

<section class="properties-section py-5">
    <div class="container">
        <div class="row">
            
            <div class="col-lg-3 mb-4">
                <div class="filter-sidebar">
                    <h5 class="mb-4"><i class="bi bi-sliders"></i> Filters</h5>
                    <form method="get">
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold">City</label>
                            <select class="form-select" name="city">
                                <option value="">All Cities</option>
                                {% for city in cities %}
                                    <option value="{{ city }}" {% if request.GET.city == city %}selected{% endif %}>{{ city }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Property Type</label>
                            <select class="form-select" name="property_type">
                                <option value="">All Types</option>
                                {% for value, label in property_types %}
                                    <option value="{{ value }}" {% if request.GET.property_type == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Listing Type</label>
                            <select class="form-select" name="listing_type">
                                <option value="">Any</option>
                                {% for value, label in listing_types %}
                                    <option value="{{ value }}" {% if request.GET.listing_type == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Price Range</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" name="min_price" placeholder="Min" value="{{ request.GET.min_price }}">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" name="max_price" placeholder="Max" value="{{ request.GET.max_price }}">
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Bedrooms</label>
                            <select class="form-select" name="min_bedrooms">
                                <option value="">Any</option>
                                <option value="1" {% if request.GET.min_bedrooms == '1' %}selected{% endif %}>1+</option>
                                <option value="2" {% if request.GET.min_bedrooms == '2' %}selected{% endif %}>2+</option>
                                <option value="3" {% if request.GET.min_bedrooms == '3' %}selected{% endif %}>3+</option>
                                <option value="4" {% if request.GET.min_bedrooms == '4' %}selected{% endif %}>4+</option>
                                <option value="5" {% if request.GET.min_bedrooms == '5' %}selected{% endif %}>5+</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Zoning</label>
                            <select class="form-select" name="zoning_type">
                                <option value="">Any</option>
                                {% for value, label in zoning_types %}
                                    <option value="{{ value }}" {% if request.GET.zoning_type == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_waterfront" value="true" id="waterfront" {% if request.GET.is_waterfront == 'true' %}checked{% endif %}>
                                <label class="form-check-label" for="waterfront">Waterfront</label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Sort By</label>
                            <select class="form-select" name="sort">
                                <option value="-created_at" {% if request.GET.sort == '-created_at' or not request.GET.sort %}selected{% endif %}>Newest First</option>
                                <option value="created_at" {% if request.GET.sort == 'created_at' %}selected{% endif %}>Oldest First</option>
                                <option value="price" {% if request.GET.sort == 'price' %}selected{% endif %}>Price: Low to High</option>
                                <option value="-price" {% if request.GET.sort == '-price' %}selected{% endif %}>Price: High to Low</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-filter"></i> Apply Filters
                        </button>
                        <a href="{% url 'property_list' %}" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-x"></i> Clear All
                        </a>
                    </form>
                </div>
            </div>

            <div class="col-lg-9">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0">{{ total_count }} Properties Found</h4>
                    <a href="{% url 'property_search' %}" class="btn btn-outline-primary">
                        <i class="bi bi-search"></i> Advanced Search
                    </a>
                </div>

                {% if properties %}
                    <div class="row g-4">
                        {% for property in properties %}
                            <div class="col-md-6 col-lg-4">
                                <div class="card property-card h-100">
                                    <div class="position-relative">
                                        {% if property.images.all %}
                                            {% with property.images.all.0 as first_image %}
                                                <img src="{{ first_image.image.url }}" class="card-img-top" alt="{{ property.title }}" loading="lazy">
                                            {% endwith %}
                                        {% else %}
                                            <img src="https://via.placeholder.com/400x250?text=No+Image" class="card-img-top" alt="No image">
                                        {% endif %}
                                        
                                        {% if user.is_authenticated %}
                                            <form method="post" action="{% url 'property_favorite_toggle' property.pk %}" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" class="favorite-btn">
                                                    <i class="bi bi-heart-fill"></i>
                                                </button>
                                            </form>
                                        {% endif %}

                                        <span class="badge bg-primary position-absolute top-0 start-0 m-2">
                                            {{ property.get_listing_type_display }}
                                        </span>
                                    </div>
                                    
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <a href="{% url 'property_detail' property.pk %}" class="text-decoration-none text-dark">
                                                {{ property.title|truncatewords:8 }}
                                            </a>
                                        </h5>
                                        
                                        <p class="property-price mb-2">
                                            {{ property.currency }} {{ property.price|floatformat:0 }}
                                        </p>
                                        
                                        <p class="text-muted small mb-3">
                                            <i class="bi bi-geo-alt"></i> {{ property.city }}, {{ property.state }}
                                        </p>
                                        
                                        <div class="d-flex gap-3 text-muted small">
                                            {% if not property.is_land %}
                                                {% if property.bedrooms %}
                                                    <span><i class="bi bi-door-closed"></i> {{ property.bedrooms }} Beds</span>
                                                {% endif %}
                                                {% if property.bathrooms %}
                                                    <span><i class="bi bi-droplet"></i> {{ property.bathrooms }} Baths</span>
                                                {% endif %}
                                                {% if property.area_sqft %}
                                                    <span><i class="bi bi-arrows-angle-expand"></i> {{ property.area_sqft|floatformat:0 }} sqft</span>
                                                {% endif %}
                                            {% else %}
                                                {% if property.land_size_acres %}
                                                    <span><i class="bi bi-geo"></i> {{ property.land_size_acres }} acres</span>
                                                {% endif %}
                                                {% if property.zoning_type %}
                                                    <span><i class="bi bi-file-text"></i> {{ property.get_zoning_type_display }}</span>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        
                                        <div class="mt-3">
                                            <span class="badge badge-custom bg-light text-dark">{{ property.get_property_type_display }}</span>
                                            {% if property.is_waterfront %}
                                                <span class="badge badge-custom bg-info text-white">Waterfront</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="card-footer bg-white border-top-0">
                                        <a href="{% url 'property_detail' property.pk %}" class="btn btn-outline-primary w-100">
                                            View Details <i class="bi bi-arrow-right"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    {% if properties.has_other_pages %}
                        <nav aria-label="Page navigation" class="mt-5">
                            <ul class="pagination justify-content-center">
                                {% if properties.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                            <i class="bi bi-chevron-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ properties.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}

                                <li class="page-item active">
                                    <span class="page-link">Page {{ properties.number }} of {{ properties.paginator.num_pages }}</span>
                                </li>

                                {% if properties.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ properties.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ properties.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                            <i class="bi bi-chevron-double-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}

                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-search display-1 text-muted"></i>
                        <h3 class="mt-3">No Properties Found</h3>
                        <p class="text-muted">Try adjusting your filters or search criteria</p>
                        <a href="{% url 'property_list' %}" class="btn btn-primary mt-3">
                            <i class="bi bi-arrow-clockwise"></i> Reset Filters
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

{% endblock %}