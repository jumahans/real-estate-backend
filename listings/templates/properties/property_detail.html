{% extends 'properties/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ property.title }} | ArthiProperties{% endblock %}

{% block extra_css %}
<style>
    /* --- HERO GALLERY --- */
    .hero-gallery { height: 500px; overflow: hidden; border-radius: 1rem; }
    .hero-img-main { height: 100%; width: 100%; object-fit: cover; cursor: pointer; transition: transform 0.3s; }
    .hero-img-sub { height: 50%; width: 100%; object-fit: cover; cursor: pointer; transition: filter 0.2s; border: 2px solid white; }
    
    .hero-img-main:hover { transform: scale(1.02); }
    .hero-img-sub:hover { filter: brightness(0.8); }

    .more-photos-overlay {
        position: absolute; inset: 0; 
        background: rgba(0,0,0,0.6);
        color: white; font-weight: 700;
        display: flex; align-items: center; justify-content: center;
        pointer-events: none;
    }

    /* --- STICKY SIDEBAR --- */
    .sticky-sidebar { position: sticky; top: 100px; z-index: 10; }
    
    /* --- TABS Styling --- */
    .nav-pills .nav-link {
        color: var(--brand-primary);
        background: #f8f9fa;
        border: 1px solid transparent;
        margin: 0 2px;
        transition: all 0.2s;
    }
    .nav-pills .nav-link.active {
        background-color: var(--brand-primary);
        color: white;
        box-shadow: 0 4px 10px rgba(27, 77, 62, 0.2);
    }

    /* --- FEATURE ICONS --- */
    .feature-box {
        background: #fcfcfc;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.2s;
    }
    .feature-box:hover { transform: translateY(-3px); border-color: var(--brand-secondary); }
    .feature-icon {
        font-size: 1.8rem; color: var(--brand-primary); margin-bottom: 0.5rem;
    }

    /* --- AMENITIES LIST --- */
    .amenity-item { font-size: 0.95rem; color: #555; }
    .amenity-item i { color: var(--brand-secondary); width: 25px; }

    /* --- FORM INPUTS --- */
    .form-control, .form-select {
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    .form-control:focus {
        background-color: #fff;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 4px rgba(27, 77, 62, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-3 mb-2">
                {{ property.get_property_type_display }}
            </span>
            <h1 class="display-5 fw-bold mb-1" style="font-family: var(--font-heading);">{{ property.title }}</h1>
            <p class="text-muted fs-5 mb-0">
                <i class="bi bi-geo-alt text-secondary me-1"></i> {{ property.address }}, {{ property.city }}
            </p>
        </div>
        <div class="text-end d-none d-md-block">
            <h2 class="fw-bold mb-0" style="color: var(--brand-primary);">
                {{ property.currency }} {{ property.price|floatformat:0|intcomma }}
            </h2>
            <p class="small text-muted mb-0">
                {% if property.status == 'rented' %} / Month {% else %} Guide Price {% endif %}
            </p>
        </div>
    </div>

    <div class="row g-0 hero-gallery mb-5 shadow-sm">
        <div class="col-md-8 h-100 position-relative">
            {% if property.images.first %}
                <img src="{{ property.images.first.image.url }}" class="hero-img-main" alt="{{ property.title }}">
                <span class="badge bg-dark bg-opacity-75 position-absolute bottom-0 start-0 m-3 px-3 py-2 rounded-pill">
                    <i class="bi bi-camera me-1"></i> {{ property.images.count }} Photos
                </span>
            {% else %}
                <div class="bg-secondary h-100 w-100 d-flex align-items-center justify-content-center text-white">
                    <i class="bi bi-image display-1 opacity-50"></i>
                </div>
            {% endif %}
        </div>

        <div class="col-md-4 h-100 d-none d-md-block">
            <div class="d-flex flex-column h-100">
                {% for img in property.images.all|slice:"1:3" %}
                    <div class="position-relative h-50">
                        <img src="{{ img.image.url }}" class="hero-img-sub" alt="View">
                        
                        {% if forloop.last and property.images.count > 3 %}
                            <div class="more-photos-overlay h-100">
                                +{{ property.images.count|add:"-3" }} More
                            </div>
                        {% endif %}
                    </div>
                {% empty %}
                    <div class="h-100 bg-light d-flex align-items-center justify-content-center text-muted border border-white">
                        <small>Gallery coming soon</small>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="row g-5">
        <div class="col-lg-8">
            
            <div class="row g-3 mb-5">
                <div class="col-6 col-md-3">
                    <div class="feature-box">
                        <i class="bi bi-moon-stars feature-icon"></i>
                        <div class="fw-bold">{{ property.bedrooms|default:"-" }} Beds</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="feature-box">
                        <i class="bi bi-droplet feature-icon"></i>
                        <div class="fw-bold">{{ property.bathrooms|default:"-" }} Baths</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="feature-box">
                        <i class="bi bi-bounding-box-circles feature-icon"></i>
                        <div class="fw-bold">{{ property.area_sqft|intcomma|default:"-" }} SqFt</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="feature-box">
                        <i class="bi bi-calendar4-week feature-icon"></i>
                        <div class="fw-bold">{{ property.year_built|default:"N/A" }}</div>
                    </div>
                </div>
            </div>

            <div class="mb-5">
                <h4 class="fw-bold mb-3 font-heading border-bottom pb-2">Description</h4>
                <div class="text-muted lh-lg">
                    {{ property.description|linebreaks }}
                </div>
            </div>

            <div class="mb-5">
                <h4 class="fw-bold mb-4 font-heading border-bottom pb-2">Property Features</h4>
                <div class="row g-3">
                    {% if property.has_parking %}
                        <div class="col-md-6 amenity-item"><i class="bi bi-car-front-fill"></i> Parking ({{ property.parking_spaces }})</div>
                    {% endif %}
                    {% if property.has_swimming_pool %}
                        <div class="col-md-6 amenity-item"><i class="bi bi-water"></i> Swimming Pool</div>
                    {% endif %}
                    {% if property.has_garden %}
                        <div class="col-md-6 amenity-item"><i class="bi bi-flower1"></i> Private Garden</div>
                    {% endif %}
                    {% if property.has_security %}
                        <div class="col-md-6 amenity-item"><i class="bi bi-shield-check"></i> 24/7 Security</div>
                    {% endif %}
                    {% if property.has_gym %}
                        <div class="col-md-6 amenity-item"><i class="bi bi-bicycle"></i> Fitness Gym</div>
                    {% endif %}
                    {% if property.has_elevator %}
                        <div class="col-md-6 amenity-item"><i class="bi bi-arrow-up-square"></i> Elevator Access</div>
                    {% endif %}
                    
                    <div class="col-md-6 amenity-item"><i class="bi bi-check-circle"></i> Modern Finishes</div>
                    <div class="col-md-6 amenity-item"><i class="bi bi-check-circle"></i> Great Location</div>
                </div>
            </div>

            <div class="mb-5">
                <h4 class="fw-bold mb-3 font-heading border-bottom pb-2">Location</h4>
                <div class="bg-light rounded-4 d-flex align-items-center justify-content-center text-muted" style="height: 300px;">
                    <div class="text-center">
                        <i class="bi bi-map fs-1 opacity-50"></i>
                        <p class="mt-2 mb-0">Map integration available</p>
                        <small>{{ property.latitude }}, {{ property.longitude }}</small>
                    </div>
                </div>
            </div>

        </div>

        <div class="col-lg-4">
            <div class="sticky-sidebar">
                
                <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-3">
                    <div class="card-header bg-white p-2 border-0">
                        <ul class="nav nav-pills nav-fill bg-light rounded-3 p-1" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active fw-bold small text-uppercase" data-bs-toggle="pill" data-bs-target="#tab-book">
                                    <i class="bi bi-calendar-check me-1"></i> Book Visit
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link fw-bold small text-uppercase" data-bs-toggle="pill" data-bs-target="#tab-message">
                                    <i class="bi bi-chat-dots me-1"></i> Inquiry
                                </button>
                            </li>
                        </ul>
                    </div>

                    <div class="card-body p-4">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="tab-book">
                                {% if booking_enabled %}
                                    <div class="text-center mb-4">
                                        <h5 class="fw-bold mb-1">Schedule a Tour</h5>
                                        <p class="text-muted small">Select a date to view this property.</p>
                                    </div>
                                    
                                    <form action="{% url 'create_booking' property.pk %}" method="post">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold text-muted">Preferred Date & Time</label>
                                            {{ booking_form.start_datetime }} 
                                            </div>
                                        
                                        {% if suggested_slots %}
                                            <div class="mb-3">
                                                <small class="d-block text-muted small mb-2">Next Available:</small>
                                                <div class="d-flex flex-wrap gap-2">
                                                    {% for slot in suggested_slots %}
                                                        <span class="badge bg-light text-dark border">{{ slot|date:"D, H:i" }}</span>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endif %}

                                        <button type="submit" class="btn btn-primary w-100 rounded-pill py-3 fw-bold shadow-sm">
                                            Request Booking
                                        </button>
                                    </form>
                                {% else %}
                                    <div class="text-center py-5">
                                        <i class="bi bi-calendar-x display-4 text-muted opacity-25"></i>
                                        <p class="mt-3 fw-bold">Bookings Unavailable</p>
                                        <p class="small text-muted">Please contact the agent directly via message.</p>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="tab-pane fade" id="tab-message">
                                <div class="text-center mb-4">
                                    <h5 class="fw-bold mb-1">Contact Agent</h5>
                                    <p class="text-muted small">Send a direct message regarding this listing.</p>
                                </div>
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="submit_inquiry" value="1">
                                    
                                    <div class="mb-3">
                                        {{ inquiry_form.inquirer_name }}
                                    </div>
                                    <div class="mb-3">
                                        {{ inquiry_form.inquirer_email }}
                                    </div>
                                    <div class="mb-3">
                                        {{ inquiry_form.message }}
                                    </div>

                                    <button type="submit" class="btn btn-dark w-100 rounded-pill py-3 fw-bold shadow-sm">
                                        Send Message
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="card-footer bg-light p-3 d-flex align-items-center gap-3">
                        <div class="bg-white border rounded-circle d-flex align-items-center justify-content-center text-primary fw-bold shadow-sm" style="width: 45px; height: 45px;">
                            {{ property.owner.username|slice:":1"|upper }}
                        </div>
                        <div class="lh-1">
                            <small class="text-muted d-block" style="font-size: 0.75rem;">LISTED BY</small>
                            <span class="fw-bold text-dark">{{ property.owner.get_full_name|default:property.owner.username }}</span>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-white border w-100 rounded-pill shadow-sm py-2 hover-primary" onclick="shareProperty()">
                        <i class="bi bi-share me-2"></i> Share
                    </button>
                    <button class="btn btn-white border w-100 rounded-pill shadow-sm py-2 hover-danger" 
                            data-pk="{{ property.pk }}" 
                            onclick="toggleFavorite(this)"
                            style="color: {% if is_favorited %}#dc3545{% else %}#444{% endif %};">
                        <i class="bi {% if is_favorited %}bi-heart-fill{% else %}bi-heart{% endif %} me-2"></i> Save
                    </button>
                </div>

            </div>
        </div>
    </div>
    
    {% if similar_properties %}
    <div class="mt-5 pt-5 border-top">
        <h3 class="fw-bold mb-4 font-heading">You might also like</h3>
        <div class="row g-4">
            {% for prop in similar_properties %}
            <div class="col-md-4">
                <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                    <div class="position-relative" style="height: 200px;">
                        {% if prop.images.first %}
                            <img src="{{ prop.images.first.image.url }}" class="w-100 h-100 object-fit-cover">
                        {% else %}
                            <div class="bg-secondary w-100 h-100 d-flex align-items-center justify-content-center text-white"><i class="bi bi-building"></i></div>
                        {% endif %}
                        <div class="position-absolute bottom-0 start-0 p-3 text-white w-100 bg-gradient-to-t">
                            <h6 class="mb-0 fw-bold">{{ prop.currency }} {{ prop.price|intword }}</h6>
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="fw-bold text-truncate"><a href="{% url 'property_detail' prop.pk %}" class="text-dark text-decoration-none">{{ prop.title }}</a></h6>
                        <p class="small text-muted mb-0"><i class="bi bi-geo-alt"></i> {{ prop.city }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>

<script>
    function shareProperty() {
        if (navigator.share) {
            navigator.share({
                title: '{{ property.title }}',
                text: 'Check out this property on ArthiProperties!',
                url: window.location.href,
            });
        } else {
            // Fallback
            navigator.clipboard.writeText(window.location.href);
            alert('Link copied to clipboard!');
        }
    }
</script>

<style>
    /* Styling for the Forms inside sidebar */
    .tab-content input, .tab-content textarea {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    .hover-primary:hover { color: var(--brand-primary); border-color: var(--brand-primary) !important; }
    .hover-danger:hover { color: #dc3545; border-color: #dc3545 !important; }
    .bg-gradient-to-t { background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); }
</style>
{% endblock %}